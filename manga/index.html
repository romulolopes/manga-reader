<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<title>Leitor de Imagens</title>

<style>
  html,body {
    margin:0; padding:0; background:#111; color:white;
    font-family:Helvetica,Arial;
    height:100%; overflow:hidden;
  }

  /* MENU CONFIG */
  #configMenu {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:#000d; display:flex; flex-direction:column;
    justify-content:center; align-items:center; z-index:999;
    backdrop-filter: blur(3px);
  }
  #configMenu input {
    margin:8px 0; padding:8px; width:80%; font-size:18px;
  }
  #startBtn {
    padding:10px 18px; font-size:18px; margin-top:10px;
  }

  /* Bot√£o reabrir menu */
  #menuBtn {
    position:fixed; left:10px; bottom:10px;
    padding:10px 14px; background:#444; 
    color:white; cursor:pointer; z-index:1000;
    border-radius:8px;
  }

  #container {
    display:flex; align-items:center; justify-content:center;
    height:100vh; position:relative;
    display:none;
  }

  #viewer {
    max-width:90%;
    max-height:80vh;
  }

  .zone {
    position:absolute; top:0; height:100%; width:40%; cursor:pointer;
  }
  #leftZone { left:0; }
  #rightZone { right:0; }

  #fsBtn {
    position:fixed; top:10px; right:10px; z-index:1000;
    padding:6px 10px; background:#333; color:white; display:none;
  }
</style>
</head>
<body>

<!-- MENU DE CONFIGURA√á√ÉO -->
<div id="configMenu">
  <h2>Configura√ß√£o</h2>

  <input id="baseUrl" type="text" placeholder="URL base" value="https://mugiwarasoficial.com/manga/manga-one-piece/">
  <input id="chapterNum" type="number" placeholder="Cap√≠tulo" value="1168">

  <button id="startBtn">Iniciar Leitura</button>
</div>

<!-- Input oculto usado internamente -->
<input id="urlBox" type="text" style="display:none">

<button id="fsBtn">Tela cheia</button>
<button id="menuBtn">Configura√ß√£o</button>

<!-- VISOR -->
<div id="container">
  <img id="viewer" src="" alt="Aguardando‚Ä¶" />
  <div id="leftZone" class="zone"></div>
  <div id="rightZone" class="zone"></div>
</div>


<script>
var images = [];
var index = 0;
var fullscreen = false;

/* ------------------------------
      FUN√á√ÉO DE EXTRA√á√ÉO
--------------------------------*/
function extractImagesFromHTML(html, baseURL) {
  var tmp = document.createElement("div");
  tmp.innerHTML = html;

  var list = tmp.querySelectorAll("img.wp-manga-chapter-img");
  var arr = [];

  var base = document.createElement("a");
  base.href = baseURL;

  for (var i = 0; i < list.length; i++) {
    var src =
      list[i].getAttribute("data-src") ||
      list[i].getAttribute("data-lazy-src") ||
      list[i].getAttribute("data-original") ||
      list[i].getAttribute("src");

    if (!src) continue;

    src = src.trim();

    if (src.startsWith("http")) {
      arr.push(src); continue;
    }
    if (src.startsWith("//")) {
      arr.push("https:" + src); continue;
    }
    if (src.startsWith("/")) {
      arr.push(base.protocol + "//" + base.host + src);
      continue;
    }

    arr.push(base.protocol + "//" + base.host + "/" + src);
  }

  return arr;
}

/* ------------------------------
          CARREGAR
--------------------------------*/
function loadChapter() {
  var url = document.getElementById("urlBox").value;

  var xhr = new XMLHttpRequest();
  xhr.open("GET", "/fetch?url=" + encodeURIComponent(url), true);

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
      if (xhr.status >= 200 && xhr.status < 300) {

        var html = xhr.responseText;
        images = extractImagesFromHTML(html, url);

        if (images.length > 0) {
          index = 0;
          document.getElementById("viewer").src = images[0];
        } else {
          document.getElementById("viewer").alt = "Nenhuma imagem encontrada.";
        }

      } else {
        document.getElementById("viewer").alt = "Erro ao carregar.";
      }
    }
  };

  xhr.send();
}

/* Navega√ß√£o */
function showIndex(i) {
  if (!images.length) return;
  index = (i + images.length) % images.length;
  document.getElementById("viewer").src = images[index];
}

function nextImg() {
  if (!images.length) return;

  // Se ainda N√ÉO √© a √∫ltima imagem
  if (index < images.length - 1) {
    showIndex(index + 1);
    return;
  }

  // üëá CHEGOU NA √öLTIMA IMAGEM
  // Incrementa o cap√≠tulo
  let chapterInput = document.getElementById("chapterNum");
  let current = parseInt(chapterInput.value, 10) || 0;
  chapterInput.value = current + 1;

  // Gera nova URL
  let b = document.getElementById("baseUrl").value.trim();
  if (!b.endsWith("/")) b += "/";
  let finalURL = b + "capitulo-" + chapterInput.value;

  document.getElementById("urlBox").value = finalURL;

  // Recarrega o novo cap√≠tulo
  loadChapter();
}


function prevImg() { showIndex(index - 1); }

document.getElementById("leftZone").onclick = prevImg;
document.getElementById("rightZone").onclick = nextImg;

/* Fullscreen */
document.getElementById("fsBtn").onclick = function() {
  var v = document.getElementById("viewer");
  if (!fullscreen) {
    fullscreen = true;
    this.innerHTML = "Sair";
    v.style.maxWidth = "100%";
    v.style.maxHeight = "100vh";
    document.body.style.background = "#fff";
    document.getElementById("container").style.background = "#fff";
  } else {
    fullscreen = false;
    this.innerHTML = "Tela cheia";
    v.style.maxWidth = "90%";
    v.style.maxHeight = "80vh";
    document.body.style.background = "#111";
    document.getElementById("container").style.background = "#111";
  }
};

/* -----------------------------------------
       MENU ‚Üí GERA URL ‚Üí SOME
------------------------------------------*/
document.getElementById("startBtn").onclick = function() {

  let b = document.getElementById("baseUrl").value.trim();
  let c = document.getElementById("chapterNum").value.trim();

  if (!b.endsWith("/")) b += "/";
  let finalURL = b +'capitulo-'+ c ;

  document.getElementById("urlBox").value = finalURL;

  document.getElementById("configMenu").style.display = "none";
  document.getElementById("container").style.display = "flex";
  document.getElementById("fsBtn").style.display = "block";

  loadChapter();
};

/* -----------------------------
    REABRIR O MENU
------------------------------*/
document.getElementById("menuBtn").onclick = function () {
  document.getElementById("configMenu").style.display = "flex";
};
</script>

</body>
</html>
